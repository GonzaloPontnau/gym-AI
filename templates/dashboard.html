{% extends "base.html" %}

{% block title %}GymAI - {{ routine.routine_name }}{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        height: calc(100vh - 100px);
        display: flex;
        flex-direction: row;
    }
    
    .routine-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    
    .chat-container {
        width: 35%;
        min-width: 350px;
        display: flex;
        flex-direction: column;
        border-left: 1px solid #dee2e6;
    }
    
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .chat-input-container {
        padding: 1rem;
        border-top: 1px solid #dee2e6;
        background: #f8f9fa;
    }
    
    .message {
        padding: 0.75rem;
        border-radius: 0.5rem;
        max-width: 90%;
        white-space: pre-wrap;
    }
    
    .user-message {
        background-color: #d1ecf1;
        align-self: flex-end;
        margin-left: auto;
    }
    
    .assistant-message {
        background-color: #e9ecef;
        align-self: flex-start;
        margin-right: auto;
    }
    
    .day-card {
        margin-bottom: 1.5rem;
    }
    
    .exercise-row:nth-child(even) {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .table-equipment {
        font-style: italic;
        color: #6c757d;
    }
    
    @media (max-width: 992px) {
        .dashboard-container {
            flex-direction: column;
            height: auto;
        }
        
        .chat-container {
            width: 100%;
            min-width: unset;
            height: 500px;
            border-left: none;
            border-top: 1px solid #dee2e6;
            margin-top: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Panel de rutina -->
    <div class="routine-container">
        <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
            <h1 id="routine-name">{{ routine.routine_name }}</h1>
            <div>
                <a href="/routines" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left"></i> Volver a mis rutinas
                </a>
            </div>
        </div>
        
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            Puedes modificar esta rutina usando el chat lateral. Pide añadir ejercicios, cambiar repeticiones o adaptar la rutina a tus necesidades.
        </div>
        
        <div id="routine-content">
            {% for day in routine.days %}
            <div class="card day-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">{{ day.day_name }} - {{ day.focus }}</h3>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ejercicio</th>
                                <th>Series</th>
                                <th>Repeticiones</th>
                                <th>Descanso</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for exercise in day.exercises %}
                            <tr class="exercise-row">
                                <td>
                                    {{ exercise.name }}
                                    <div class="table-equipment">{{ exercise.equipment }}</div>
                                </td>
                                <td>{{ exercise.sets }}</td>
                                <td>{{ exercise.reps }}</td>
                                <td>{{ exercise.rest }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Panel de chat -->
    <div class="chat-container">
        <div class="chat-header bg-primary text-white p-2">
            <h3 class="mb-0 text-center"><i class="bi bi-chat-dots"></i> Personaliza tu rutina</h3>
        </div>
        
        <div class="chat-messages" id="chat-messages">
            {% for message in chat_history %}
                <div class="message {% if message.sender == 'user' %}user-message{% else %}assistant-message{% endif %}">
                    {{ message.content }}
                </div>
            {% endfor %}
        </div>
        
        <div class="chat-input-container">
            <form id="chat-form" class="d-flex">
                <input type="text" id="message-input" class="form-control me-2" placeholder="Escribe tu mensaje aquí..." required>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Referencias a elementos
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const messagesContainer = document.getElementById('chat-messages');
        const routineContent = document.getElementById('routine-content');
        const routineName = document.getElementById('routine-name');
        
        // ID de la rutina actual
        const routineId = {{ routine_id }};
        
        // Scroll al final del chat
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Agregar un mensaje al chat
        function addMessage(content, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(sender === 'user' ? 'user-message' : 'assistant-message');
            messageDiv.textContent = content;
            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // Actualizar la vista de la rutina
        function updateRoutineView(routine) {
            // Actualizar el nombre de la rutina
            routineName.textContent = routine.routine_name;
            
            // Limpiar el contenido actual
            routineContent.innerHTML = '';
            
            // Crear HTML para cada día
            routine.days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.classList.add('card', 'day-card');
                
                dayCard.innerHTML = `
                    <div class="card-header bg-primary text-white">
                        <h3 class="mb-0">${day.day_name} - ${day.focus}</h3>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Ejercicio</th>
                                    <th>Series</th>
                                    <th>Repeticiones</th>
                                    <th>Descanso</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${day.exercises.map(exercise => `
                                    <tr class="exercise-row">
                                        <td>
                                            ${exercise.name}
                                            <div class="table-equipment">${exercise.equipment}</div>
                                        </td>
                                        <td>${exercise.sets}</td>
                                        <td>${exercise.reps}</td>
                                        <td>${exercise.rest}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                routineContent.appendChild(dayCard);
            });
        }
        
        // Configurar WebSocket
        let ws;
        function setupWebSocket() {
            // Crear conexión WebSocket
            ws = new WebSocket(`ws://${window.location.host}/ws/chat/${routineId}`);
            
            // Configurar eventos del WebSocket
            ws.onopen = () => {
                console.log('Conexión WebSocket establecida');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'routine_update') {
                    // Actualizar la rutina en la interfaz
                    updateRoutineView(data.routine);
                    
                    // Agregar mensaje del asistente
                    addMessage(data.explanation, 'assistant');
                } else if (data.error) {
                    console.error('Error:', data.error);
                    addMessage('Ha ocurrido un error. Por favor, intenta de nuevo.', 'assistant');
                }
            };
            
            ws.onclose = () => {
                console.log('Conexión WebSocket cerrada');
                // Intentar reconectar después de un tiempo
                setTimeout(setupWebSocket, 3000);
            };
            
            ws.onerror = (error) => {
                console.error('Error en la conexión WebSocket:', error);
            };
        }
        
        // Iniciar WebSocket
        setupWebSocket();
        
        // Manejar envío de mensajes
        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Agregar mensaje al chat
            addMessage(message, 'user');
            
            // Enviar mensaje por WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
            } else {
                addMessage('Error de conexión. Intentando reconectar...', 'assistant');
                setupWebSocket();
            }
            
            // Limpiar campo de entrada
            messageInput.value = '';
        });
        
        // Scroll inicial al final del chat
        scrollToBottom();
    });
</script>
{% endblock %}